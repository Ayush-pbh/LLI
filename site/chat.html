<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <!-- Materialize CSS & JS -->
    <link rel="stylesheet" href="./css/materialize.min.css">
    <script src="./js/materialize.min.js"></script>
    <!-- Custom CSS & JS -->
    <link rel="stylesheet" href="./css/materialfonts.css">
    <link rel="stylesheet" href="./css/universal-style.css">
    
      
</head>
<body>
    <!-- Navbar -->
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper green lighten-1">
                <span class="left brand-logo chatroom-close-logo visible" onclick="window.open('chatroom.html','_self')"><i class="material-icons sidenav-trigger">arrow_back</i></span>
            </div>
        </nav>
    </div>
    <!-- Body -->
    <div class="chatroom visible">
        <div class="chats">
            <div class="row">
                <div class="col s12 center-align">
                    <br>
                    <div class="waves-effect waves-light btn">Load Previous Chats</div>
                </div>
            </div>
            
        </div>
        <div class="input-f">
            <input type="text" placeholder="write-text-here!" class="send-text">            
            <div class="btn-floating send waves-effect waves-light green lighten-1 " onclick="sendd()"><i class="material-icons">send</i></div>
            <div class="btn-floating insertDocs waves-effect waves-light green lighten-1"><i class="material-icons">add</i></div>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="./js/universal-script.js"></script>
    <script>
        var socket = io();
        // Client sends the first message to the server while connecting 
        // caseId = case chatroom user wants to chat in...
        // loginToken = to verify that the user exsist in the chatroom or not.
        let caseId = localStorage.getItem('chat-case-id')
        let loginToken = localStorage.getItem('token')
        let myId = localGet('currentLoginUser',true)._id
        let myname = localGet('currentLoginUser',true).fname

        socket.emit("chat-init", {caseId : caseId, loginToken : loginToken}, (response) => {
            console.log(response);
        });
        socket.on('chat-message', (arg)=>{
            if(arg.senderId != myId){
                console.log(arg.msg)
                document.getElementsByClassName('chats')[0].innerHTML +=  `<div class="chat chat-recv ">
    <div class="chat-align-holder"><div class="chat-holder"><span class="writer-name">${arg.senderName}</span>${arg.msg}</div><div class="time"></div></div></div>`
            let ss = document.getElementsByClassName('chats')[0]
            ss.scroll(0,ss.scrollHeight)
            }

        })

        function sendMessage(msg){
            let currentDate = new Date()
            socket.emit("chat-message", {
                caseId : caseId,
                senderId : myId,
                senderName : myname,
                datetime : currentDate,
                msg:msg
            }); 
            
            document.getElementsByClassName('chats')[0].innerHTML +=  `<div class="chat chat-send ">
    <div class="chat-align-holder"><div class="chat-holder"><span class="writer-name"></span>${msg}</div><div class="time"></div></div></div>`
        }
        function sendd(){
            let txt = document.getElementsByClassName('send-text')[0].value
            sendMessage(txt)
            document.getElementsByClassName('send-text')[0].value = ''
            let ss = document.getElementsByClassName('chats')[0]
            ss.scroll(0,ss.scrollHeight)
        }
    </script>
</body>
</html>